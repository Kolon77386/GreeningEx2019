# ステージ選択シーンの星の海の色変化
ステージ選択シーンで、クリアした島の周りを、綺麗な海に切り替える。

## 方法
島の形状に合わせて色を変える場所を調整したいので、モデルの頂点から、影響が出るテクスチャーのUV値を求めて変化の度合いを決めたい。シェーダーでもできそうだが、スペキュラーの変更などもしたいので、調べるのがやや面倒である。そこで、Standardシェーダーを使ってAlbedoに貼り付けたテクスチャーを動的に書き換えることで実現する。

## 球体からUVへの変換
テクスチャーを貼り付けて調査したところ、星のUV値は以下の通りであった。

- 球体の上は、Vが0。Uはどこでも同じなので、0でよいだろう
- 球体の下は、Vが1。Uはどこでも同じなので、1でよいだろう
- 経度は、手前が3/16、右方向が7/16、奥が11/16、左が15/16

以上から、中心からの方向を与えて、UV値を算出することができる。

## UVから球体への変換
- 上記の定義から、Xの値から、X-Z平面の位置を決める
- Yの値から、-90～90の角度を求める
  - x = R *
  - 半径(R)はテクスチャサイズ、YがYより、x = R
- 1で求めたX-Z平面のベクトルを、Yの角度回転させる
  - 軸は、X-Z平面のベクトルと、Vector3.upの外積

## 島の座標
島の座標は、星のモデルのverticesから算出する。

- Mesh Filterの値を参照するので、Projectウィンドウでモデルデータを選択して、InspectorウィンドウでModelを選択して、*Read/Wite Enabled*にチェックを入れておく
- モデル座標からワールド座標への位置の変換は、transform.TransformPoint()を利用すると楽

以上を計算して、島の頂点を算出する。

## 海の色の割合
海のテクスチャーは、64～256程度の粗いもので計算する。頂点から島の影響を受ける距離を定義して、各頂点ごとにUV値を計算して、そこから既定の範囲にクリア状況の色を反映させる。

- 島からの距離に応じて、影響力と色を算出する
  - int 影響値 未クリア(-1) or 影響なし(0) or クリア(1)
  - float 割合 0～1
- 全ての島について、上記の(影響値*割合)を合計して、0～1でクランプした値で、未クリアとクリアの割合を算出する

色はアニメーションさせたいので、前後の状態をそれぞれテクスチャーで作成して、それらを割合で合成できるようにする。

## 島からUVの距離の算出(未実装)
各頂点からの距離を積和するだけだと、値が重なってしまって島の外に奇麗なグラデーションをかけることができなかった。そこで、各頂点への角度も含めて算出することを検討する。

- 島の中心を算出
- チェックする頂点から、島の頂点へのベクトルを求める = checkVec
- 星の中心からチェックする頂点へのベクトルと、島の中心へのベクトルの外積を求める = checkNormal
- 島の中心から、島の頂点へのベクトルを求める = vertVec
- checkVecとvertVecの内積を求める。これが負の値なら、90度以上違うので、内部候補
- checkVecとcheckNormalの内積を求める。正と負で方向が分かるので、両サイドが90度を越えていたら、その時点で100%にする
- チェック頂点と島頂点の距離を求めて、最寄りの距離を記録
- 全てチェックして、両サイドが90度以上になっていない場合は島の外と見做して、最寄りの頂点からの距離で減算した値を割合とする


## データの生成スクリプト
ステージ選択シーンのBaseStarにアタッチした`MakeSeaRange.cs`スクリプトでデータを生成している。再生成する場合は有効化して、Resourcesフォルダー内のステージデータを削除してPlayする。

UNITY_EDITORで囲って、ビルド時には外すようにしている。
