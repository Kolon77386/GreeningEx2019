# 岩
岩とステラの関係はきのこに近いので、情報をやりとりする仕組みはきのこのものを応用したい。岩の動作は以下の通り。

- 押すと転がす(Actable.PushAction())
- アクションキーで飛び乗る(Actable.Action())
  - アクションキーを押すと、きのこと同じ方法で岩に飛び乗る
  - IStepOnを実装したRockStepOnクラスを作成して、StepOn()に乗った状態に移行する処理を書く
- 岩に乗った後
  - StellaRockWalkアクションを作成して移行
  - アクションキーで、岩を停止してから、向いている方向に飛び降りる
  - 乗っている場所が、岩の中心より左なら、岩は左に転がり、ステラも転がりに合わせて左に動く
  - 右も同様
  - 左右キーで移動。ターンはなし
  - 岩が足元になくなったら、岩を停止させて、Airに移行して降りる
- その他
  - 専用のアニメは不要
  - 岩にアタッチするRockActableに以下を実装する
    - 上に乗った時の転がしを指示する`Vector3 Roll(Vector3 pos)`を実装。posにはステラの座標を渡す。回転後のステラの座標を返す

## 実装
実装手順は以下の通り。

### 飛び乗る
- RockActableをMushroomActableをコピーして作成
- RockActableのAction()を、きのこと同じように実装する。コライダーがSphereColliderなので、そこを書き換えていく
- PushAction()は別の処理になるので、一先ず表示をさせておく

まずは以上で、アクションボタンで飛び乗り、押すとログが表示されることを確認。

### 岩を押す
岩は、横方向はステラが押すことでのみ移動し、Y方向は自動的に重力落下させたい。Rigidbodyだと実際に動かすタイミングが制御できないのでステラとの連携が難しい。そこで、岩の動きもCharacterControllerで実装する。重力加速度はステラと同じにする。

キャラクターコントローラーは以下の通り設定。以下以外は、見た目に合わせる。

- Slope Limit=0 / Step Offset=0 / SkinWidth=0.001 / Min Move Distance = 0.001

重力落下させれば、他のオブジェクトの上には乗らなくなる。

PushAction()を実装する。

- ステラの移動速度を取得して、ひっかかり防止のため、それより少しだけ速く移動させる
- 実際に移動した距離を回転させる
- 着地している時は、Y速度を0に戻す

### 岩に乗ったあとの歩き
StellaRockWalkとして作成する。水キーは無効。アクションキーは飛び降り。ミニジャンプチェックや歩きの補正はあり。

- IStepOnを実装したRockStepOnを作成して、岩プレハブにアタッチ
- StepOnメソッドで、生長済みなら何か表示

以上で一旦実行テスト。

歩きの時も、乗っているものを確認してStepOnを呼ばないと、乗れない場合がある。

- StellaWalkを継承して、StellaRockWalkを作成
- スクリプタブルオブジェクトとしてアセット作成
- StellaMoveのActionTypeには、`Tamanori`で定義してあるので、対応欄にアタッチ

状態が変わるかチェック。

### 岩を転がす
速度を算出したら、PushAction()を呼び出して回転させる。その際、岩の座標を記録しておいて、移動した分だけステラのX座標も動かす。
